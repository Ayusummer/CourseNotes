<!--
 * @Author: your name
 * @Date: 2021-07-07 19:15:08
 * @LastEditTime: 2021-07-08 08:16:53
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \JuniorLesson_SecondTerm\EmbeddedSystem\课程设计.md
-->
# 目录
- [目录](#目录)
- [一.课设目的](#一课设目的)
- [二.课程设计内容](#二课程设计内容)
- [三.实验方案分析与设计](#三实验方案分析与设计)
  - [3.1-RTC](#31-rtc)
    - [3.1.1-用到的硬件资源及模块工作原理](#311-用到的硬件资源及模块工作原理)
      - [3.1.1.1-时钟与分频](#3111-时钟与分频)
- [四.具体实现过程描述](#四具体实现过程描述)
- [五.实现效果](#五实现效果)
- [六.总结](#六总结)

# 一.课设目的

1、 进一步巩固掌握嵌入式系统课程所学 STM32F4 各功能模块的工作原理；

2、 进一步熟练掌握 STM32F4 各功能模块的配置与使用方法；

3、 进一步熟练掌握开发环境 Keil MDK5 的使用与程序调试技巧；

4、 自学部分功能模块的原理、配置与使用方法，培养自学能力；

5、 培养设计复杂嵌入式应用软、硬件系统的分析与设计能力。

----

# 二.课程设计内容

- 查阅资料，自学 STM32F4 的 RTC 模块，完成 RTC 的配置;
- 查阅资料，学习 STM32F4 与 LCD 的接口设计，完成 LCD 液晶屏驱动程序的设计，将时间、日期、星期等日历信息显示在 LCD 上;
- 能进行正常的日期、时间、星期显示;
- 有校时、校分功能，可以使用按键校时、校分，也可以通过串口调试助手由主机传送时间参数进行校时、校分;
- 能进行整点报时并有闹钟功能，闹钟时间可以设置多个;
- 系统关机后时间能继续运行，下次开机时间应准确;
- 查阅资料，学习 STM32F4 内部温度传感器的配置，采集、计算片内温度并显示在 LCD 上;
- 其他功能，自由发挥扩展;

----

# 三.实验方案分析与设计

描述课程设计中用到的硬件资源或模块工作原理，硬件电路的连接、模块的库函数配置方法（用到的主要库函数、配置步骤等）。

----

## 3.1-RTC

-----

### 3.1.1-用到的硬件资源及模块工作原理

- 实时时钟 (RTC) 是一个独立的 BCD 定时器/计数器。RTC 提供一个日历时钟、两个可编程 闹钟中断，以及一个具有中断功能的周期性可编程唤醒标志。

- 上电复位后，所有 RTC 寄存器都会受到保护，以防止可能的非正常写访问。

  无论器件状态如何（运行模式、低功耗模式或处于复位状态），只要电源电压保持在工作范围内，RTC 便不会停止工作。

-----

#### 3.1.1.1-时钟与分频












----

# 四.具体实现过程描述

分模块描述每个模块的具体配置流程，带注释的程序代码。必要时给出流程图。









------

# 五.实现效果

给出实现结果的效果图，PC机上的屏幕截图、开发板的运行效果照片









--------

# 六.总结

课程设计的收获与心得





-----

# 调试记录

-------

## log

- 2021.7.8
  - 修改系统时间(把第一次设置判断去掉即可)
  - 调试串口时钟
    - 按位接受数据, 设置时间的时候要一位一位输入时间
    - 闹钟设置是: `周-时-分-秒`

-----

## 串口时钟从头调试记录

- 添加 Hardware\EXTI
  - 头文件源文件均有改动
- 添加 Hardware\Key
- 添加 Hardware\BEEP
- 添加 Hardware\ADC
  - ADC 记得加 FWLIB



-----

# PPT 例程解读

- 部分摘自 `STM32F4开发指南-库函数版本_V1.2`

----

##  **STM32F4 RTC** 时钟简介

- STM32F4 的实时时钟（RTC）是一个独立的 BCD (Binary-Coded Decimal) 定时器/计数器。

- RTC 提供一个日历时钟（包含年月日时分秒信息）、两个可编程闹钟（ALARM A 和 ALARM B）中断，以及一

  个具有中断功能的周期性可编程唤醒标志。RTC 还包含用于管理低功耗模 式的自动唤醒单元。

- 两个 32 位寄存器（TR 和 DR）包含二进码十进数格式 (BCD) 的秒、分钟、小时（12 或 24 小时制）、星期、日期、月份和年份。此外，还可提供二进制格式的亚秒值。

- STM32F4 的 RTC 可以自动将月份的天数补偿为 28、29（闰年）、30 和 31 天。并且还可以进行夏令时 补偿。

- RTC 模块和时钟配置是在后备区域，即在系统复位或从待机模式唤醒后 RTC 的设置和时间维持不变，只要后备区域供电正常，那么 RTC 将可以一直运行。但是在系统复位后，会自动禁止访问后备寄存器和 RTC，以防止对后备区域(BKP)的意外写操作。所以在要设置时间之前，先要取消备份区域（BKP）写保护。

- RTC 的简化框图，如 `图 20.1.1` 所示：

  ![image-20210709195208611](http://cdn.ayusummer233.top/img/20210709195208.png)

  <center>图 20.1.1

- 本次实验我们用到 RTC 时钟和日历，并且用到闹钟功能。

---

### 1.时钟和分频

- 首先，我们看 STM32F4 的 RTC 时钟分频。STM32F4 的 RTC 时钟源（RTCCLK）通过时钟控制器，可以从 LSE 时钟、LSI 时钟以及 HSE 时钟三者中选择（通过 RCC_BDCR 寄存器选择）。一般我们选择 LSE，即外部 32.768Khz 晶振作为时钟源(RTCCLK)

  ，而 RTC 时钟核心，要求提供 1Hz 的时钟，所以，我们要设置 RTC 的可编程预分配器。STM32F4 的可编程预分配器

  （RTC_PRER）分为 2 个部分:

  - 一个通过 RTC_PRER 寄存器的 PREDIV_A 位配置的 7 位异步预分频器。
  - 一个通过 RTC_PRER 寄存器的 PREDIV_S 位配置的 15 位同步预分频器。

- 图 20.1.1 中，ck_spre 的时钟可由如下计算公式计算：

  ​														$Fck\_spre = Frtcclk/[(PREDIV\_S+1) * ( PREDIV\_A+1)]$

  其中，Fck_spre 即可用于更新日历时间等信息。PREDIV_A 和 PREDIV_S 为 RTC 的异步和同步分频器。且推荐设置 7 位异步预分频器（PREDIV_A）的值较大，以最大程度降低功耗。

  要设置为 32768 分频，我们只需要设置：PREDIV_A = 0X7F，即 127 + 1 = 128 分频；PREDIV_S = 0XFF， 即 255 + 1 = 256 分频，即可得到 1Hz 的 Fck_spre。

- 另外，图 20.1.1 中，ck_apre 可作为 RTC 亚秒递减计数器（RTC_SSR）的时钟，Fck_apre 的计算公式如下：

     													$Fck\_apre = Frtcclk/(PREDIV\_A+1)$

  当 RTC_SSR 寄存器递减到 0 的时候，会使用 PREDIV_S 的值重新装载 PREDIV_S。而 PREDIV_S 一般为 255，这样，我们得到亚秒时间的精度是：1/256 秒，即 3.9ms 左右，有了这个亚秒寄存器 RTC_SSR，就可以得到更加精确的时间数据。

----

### 2.日历时间（RTC_TR）和日期（RTC_DR）寄存器

- STM32F4 的 RTC 日历时间（RTC_TR）(Time Register)和日期（RTC_DR）(Date Register)寄存器，用于存储时间和日期（也可以用于设置时间和日期），可以通过与 PCLK1（APB1 时钟）同步的影子寄存器来访问，这些时间和日期寄存器也可以直接访问，这样可避免等待同步的持续时间
- 每隔 2 个 RTCCLK 周期，当前日历值便会复制到影子寄存器，并置位 RTC_ISR 寄存器的 RSF 位。我们可以读取 RTC_TR 和 RTC_DR 来得到当前时间和日期信息，不过需要注意的是：时间和日期都是以 BCD 码的格式存储的，读出来要转换一下，才可以得到十进制的数据

----

### 3.可编程闹钟

STM32F4 提供两个可编程闹钟：闹钟 A（ALARM_A）和闹钟 B（ALARM_B）。通过 RTC_CR 寄存器的 ALRAE 和 ALRBE 位置 1 来使能可编程闹钟功能。当日历的亚秒、秒、分、小时、日期分别与闹钟寄存器 RTC_ALRMASSR/RTC_ALRMAR 和 RTC_ALRMBSSR/RTC_ALRMBR 中的值匹配时，则可以产生闹钟（需要适当配置）。本章我们将利用闹钟 A 产生闹铃，即设置RTC_ALRMASSR 和 RTC_ALRMAR 即可。

